import{B as x,C as I,D as L,G as S,a as b,f as R,g as s,h as y,i as E,j as M,m as d,n as a,o as r,p as g,q as f,r as v,s as O,t as c,u as w,v as U,y as k,z as P}from"./chunk-2W7OKSWW.js";function D(o,i){if(o&1&&(a(0,"div",10)(1,"div",11),g(2,"div",12),r(),a(3,"div",13),c(4),r()()),o&2){let e=v();s(2),O("width",e.progress,"%"),s(2),U("",e.progress,"% - Uploading...")}}function H(o,i){if(o&1&&(a(0,"div",14)(1,"h3"),c(2,"Preview"),r(),g(3,"img",15),r()),o&2){let e=v();s(3),d("src",e.previewUrl,R)}}function j(o,i){if(o&1&&(a(0,"div",16)(1,"h4"),c(2,"Result"),r(),a(3,"pre"),c(4),r()()),o&2){let e=v();s(4),w(e.result)}}var B="https://ocr-project-3-wn71.onrender.com",T=class o{constructor(i){this.http=i}videoRef;canvasRef;stream=null;capturedBlob=null;previewUrl=null;result=null;uploading=!1;progress=0;timeoutMs=3e4;resizeBlob(i,e=1e3,t=.7){return new Promise((n,_)=>{let p=new Image,C=URL.createObjectURL(i);p.onload=()=>{let l=p.width,u=p.height;if(l>e){let m=e/l;l=Math.round(l*m),u=Math.round(u*m)}let h=document.createElement("canvas");h.width=l,h.height=u,h.getContext("2d").drawImage(p,0,0,l,u),h.toBlob(m=>{m?n(m):_(new Error("toBlob failed")),URL.revokeObjectURL(C)},"image/jpeg",t)},p.onerror=l=>{URL.revokeObjectURL(C),_(l)},p.src=C})}ngOnInit(){this.startCamera()}ngOnDestroy(){this.stopCamera(),this.previewUrl&&URL.revokeObjectURL(this.previewUrl)}async startCamera(){try{this.stream=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1}),this.videoRef=document.querySelector("video#camera"),this.videoRef.srcObject=this.stream,await this.videoRef.play()}catch(i){console.error("Camera error",i),this.result="\u05DC\u05D0 \u05D4\u05E6\u05DC\u05D7\u05E0\u05D5 \u05DC\u05D2\u05E9\u05EA \u05DC\u05DE\u05E6\u05DC\u05DE\u05D4"}}stopCamera(){this.stream&&(this.stream.getTracks().forEach(i=>i.stop()),this.stream=null)}capture(){this.canvasRef=document.querySelector("canvas#capture");let i=this.canvasRef.getContext("2d");this.canvasRef.width=this.videoRef.videoWidth||640,this.canvasRef.height=this.videoRef.videoHeight||480,i.drawImage(this.videoRef,0,0,this.canvasRef.width,this.canvasRef.height),this.canvasRef.toBlob(e=>{e&&(this.capturedBlob=e,this.previewUrl&&URL.revokeObjectURL(this.previewUrl),this.previewUrl=URL.createObjectURL(e))},"image/jpeg",.9)}upload(){this.capturedBlob&&(this.uploading=!0,this.progress=0,this.result=null,this.resizeBlob(this.capturedBlob,1e3,.7).then(i=>{let e=new FormData;e.append("file",i,"capture.jpg"),this.progress=5,this.http.post(`${B}/scan`,e,{reportProgress:!0,observe:"events"}).pipe(b(this.timeoutMs)).subscribe({next:t=>{if(t.type===x.UploadProgress){let n=t.total||1;this.progress=Math.round(100*(t.loaded/n))}else if(t.type===x.Response){let n=t.body;n&&n.sr?this.result=`SR: ${n.sr} (rows: ${n.rows})`:this.result=JSON.stringify(n,null,2),this.progress=100,setTimeout(()=>{this.progress=0},300),this.uploading=!1}},error:t=>{console.error(t),t?.name==="TimeoutError"?this.result="\u05D4\u05D1\u05E7\u05E9\u05D4 \u05D4\u05EA\u05E0\u05EA\u05E7\u05D4 \u2014 \u05D7\u05E6\u05D9\u05EA \u05D0\u05EA \u05D6\u05DE\u05DF \u05D4\u05D4\u05DE\u05EA\u05E0\u05D4 (30s). \u05E0\u05E1\u05D9 \u05E9\u05D5\u05D1 \u05D0\u05D5 \u05D1\u05D3\u05E7\u05D9 \u05D7\u05D9\u05D1\u05D5\u05E8 \u05E8\u05E9\u05EA.":t?.status===0?this.result="\u05E9\u05D2\u05D9\u05D0\u05EA \u05E8\u05E9\u05EA \u05D0\u05D5 CORS \u2014 \u05D1\u05D3\u05E7\u05D9 \u05E9\u05D4\u05E9\u05E8\u05EA \u05E8\u05E5 \u05D5\u05E9\u05D4\u2011CORS \u05DE\u05D5\u05D2\u05D3\u05E8 \u05E0\u05DB\u05D5\u05DF":t?.error?.detail?this.result=`\u05E9\u05D2\u05D9\u05D0\u05D4 \u05DE\u05D4\u05E9\u05E8\u05EA: ${t.error.detail}`:this.result="\u05E9\u05D2\u05D9\u05D0\u05D4 \u05D1\u05D4\u05E2\u05DC\u05D0\u05D4",this.uploading=!1,this.progress=0}})}).catch(i=>{console.error(i),this.result="\u05E9\u05D2\u05D9\u05D0\u05D4 \u05D1\u05E2\u05D9\u05D1\u05D5\u05D3 \u05D4\u05EA\u05DE\u05D5\u05E0\u05D4 \u05DC\u05E4\u05E0\u05D9 \u05D4\u05E2\u05DC\u05D0\u05D4",this.uploading=!1,this.progress=0}))}downloadExcel(){let i=`${B}/download-results`,e=document.createElement("a");e.href=i,e.download="results.xlsx",e.click()}static \u0275fac=function(e){return new(e||o)(y(I))};static \u0275cmp=E({type:o,selectors:[["app-camera"]],decls:14,vars:5,consts:[[1,"camera-container"],[1,"video-wrap"],["id","camera","autoplay","","muted","","playsinline",""],["id","capture","hidden",""],[1,"controls"],[3,"click"],[3,"click","disabled"],["class","upload-status",4,"ngIf"],["class","preview",4,"ngIf"],["class","result",4,"ngIf"],[1,"upload-status"],[1,"progress-bar"],[1,"progress"],[1,"progress-text"],[1,"preview"],["alt","preview","id","preview-img",3,"src"],[1,"result"]],template:function(e,t){e&1&&(a(0,"div",0)(1,"div",1),g(2,"video",2)(3,"canvas",3),r(),a(4,"div",4)(5,"button",5),f("click",function(){return t.capture()}),c(6,"\u{1F4F8} Capture"),r(),a(7,"button",6),f("click",function(){return t.upload()}),c(8),r(),a(9,"button",5),f("click",function(){return t.downloadExcel()}),c(10,"\u2B07\uFE0F Download Excel"),r()(),M(11,D,5,3,"div",7)(12,H,4,1,"div",8)(13,j,5,1,"div",9),r()),e&2&&(s(7),d("disabled",!t.capturedBlob||t.uploading),s(),w(t.uploading?"Uploading...":"Upload"),s(3),d("ngIf",t.uploading),s(),d("ngIf",t.capturedBlob),s(),d("ngIf",t.result))},dependencies:[P,k,S,L],styles:[".camera-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:1rem;align-items:center}.video-wrap[_ngcontent-%COMP%]{width:640px;max-width:100%;background:#000}video#camera[_ngcontent-%COMP%]{width:100%;height:auto;display:block}.controls[_ngcontent-%COMP%]{display:flex;gap:.5rem}.preview[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{max-width:320px;border:1px solid #ccc}.result[_ngcontent-%COMP%]   pre[_ngcontent-%COMP%]{max-width:640px;white-space:pre-wrap;word-break:break-word}.upload-status[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:.5rem}.progress-bar[_ngcontent-%COMP%]{width:300px;height:8px;background:#eee;border-radius:4px;overflow:hidden}.progress[_ngcontent-%COMP%]{height:100%;background:#4caf50;width:0%;transition:width .2s ease}.progress-text[_ngcontent-%COMP%]{font-size:.9rem;color:#333}"]})};export{T as CameraComponent};
