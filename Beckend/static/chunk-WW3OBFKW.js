import{B as b,C as L,D as P,G as B,a as R,f as y,g as l,h as I,i as O,j as U,m,n as c,o,p as f,q as v,r as w,s as E,t as p,u as _,v as M,y as S,z as k}from"./chunk-2W7OKSWW.js";function j(r,t){if(r&1&&(c(0,"div",10)(1,"div",11),f(2,"div",12),o(),c(3,"div",13),p(4),o()()),r&2){let e=w();l(2),E("width",e.progress,"%"),l(2),M("",e.progress,"% - Uploading...")}}function D(r,t){if(r&1&&(c(0,"div",14)(1,"h3"),p(2,"Preview"),o(),f(3,"img",15),o()),r&2){let e=w();l(3),m("src",e.previewUrl,y)}}function H(r,t){if(r&1&&(c(0,"div",16)(1,"h4"),p(2,"Result"),o(),c(3,"pre"),p(4),o()()),r&2){let e=w();l(4),_(e.result)}}var x="/api",T=class r{constructor(t){this.http=t}videoRef;canvasRef;stream=null;capturedBlob=null;previewUrl=null;result=null;uploading=!1;progress=0;timeoutMs=3e4;resizeBlob(t,e=1e3,i=.7){return new Promise((a,s)=>{let n=new Image,C=URL.createObjectURL(t);n.onload=()=>{let d=n.width,h=n.height;if(d>e){let u=e/d;d=Math.round(d*u),h=Math.round(h*u)}let g=document.createElement("canvas");g.width=d,g.height=h,g.getContext("2d").drawImage(n,0,0,d,h),g.toBlob(u=>{u?a(u):s(new Error("toBlob failed")),URL.revokeObjectURL(C)},"image/jpeg",i)},n.onerror=d=>{URL.revokeObjectURL(C),s(d)},n.src=C})}ngOnInit(){this.createSessionIfNeeded(),this.startCamera()}ngOnDestroy(){this.stopCamera(),this.previewUrl&&URL.revokeObjectURL(this.previewUrl)}createSessionIfNeeded(){localStorage.getItem("session_id")||this.http.get(`${x}/session`).subscribe(e=>{localStorage.setItem("session_id",e.session_id)})}async startCamera(){try{this.stream=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1}),this.videoRef=document.querySelector("video#camera"),this.videoRef.srcObject=this.stream,await this.videoRef.play()}catch(t){console.error("Camera error",t),this.result="\u05DC\u05D0 \u05D4\u05E6\u05DC\u05D7\u05E0\u05D5 \u05DC\u05D2\u05E9\u05EA \u05DC\u05DE\u05E6\u05DC\u05DE\u05D4"}}stopCamera(){this.stream&&(this.stream.getTracks().forEach(t=>t.stop()),this.stream=null)}capture(){this.canvasRef=document.querySelector("canvas#capture");let t=this.canvasRef.getContext("2d");this.canvasRef.width=this.videoRef.videoWidth||640,this.canvasRef.height=this.videoRef.videoHeight||480,t.drawImage(this.videoRef,0,0,this.canvasRef.width,this.canvasRef.height),this.canvasRef.toBlob(e=>{e&&(this.capturedBlob=e,this.previewUrl&&URL.revokeObjectURL(this.previewUrl),this.previewUrl=URL.createObjectURL(e))},"image/jpeg",.9)}upload(){if(!localStorage.getItem("session_id")){this.result="\u05D4\u05DE\u05E2\u05E8\u05DB\u05EA \u05E2\u05D3\u05D9\u05D9\u05DF \u05E0\u05D8\u05E2\u05E0\u05EA, \u05E0\u05E1\u05D9 \u05E9\u05D5\u05D1 \u05D1\u05E2\u05D5\u05D3 \u05E8\u05D2\u05E2",this.uploading=!1;return}this.capturedBlob&&(this.uploading=!0,this.progress=0,this.result=null,this.resizeBlob(this.capturedBlob,1e3,.7).then(e=>{let i=new FormData;i.append("file",e,"capture.jpg"),this.progress=5;let a=localStorage.getItem("session_id");this.http.post(`${x}/scan?session_id=${a}`,i,{reportProgress:!0,observe:"events"}).pipe(R(this.timeoutMs)).subscribe({next:s=>{if(s.type===b.UploadProgress){let n=s.total||1;this.progress=Math.round(100*(s.loaded/n))}else if(s.type===b.Response){let n=s.body;n&&n.sr?this.result=`SR: ${n.sr} (rows: ${n.rows})`:this.result=JSON.stringify(n,null,2),this.progress=100,setTimeout(()=>{this.progress=0},300),this.uploading=!1}},error:s=>{console.error(s),s?.name==="TimeoutError"?this.result="\u05D4\u05D1\u05E7\u05E9\u05D4 \u05D4\u05EA\u05E0\u05EA\u05E7\u05D4 \u2014 \u05D7\u05E6\u05D9\u05EA \u05D0\u05EA \u05D6\u05DE\u05DF \u05D4\u05D4\u05DE\u05EA\u05E0\u05D4 (30s). \u05E0\u05E1\u05D9 \u05E9\u05D5\u05D1 \u05D0\u05D5 \u05D1\u05D3\u05E7\u05D9 \u05D7\u05D9\u05D1\u05D5\u05E8 \u05E8\u05E9\u05EA.":s?.status===0?this.result="\u05E9\u05D2\u05D9\u05D0\u05EA \u05E8\u05E9\u05EA \u05D0\u05D5 CORS \u2014 \u05D1\u05D3\u05E7\u05D9 \u05E9\u05D4\u05E9\u05E8\u05EA \u05E8\u05E5 \u05D5\u05E9\u05D4\u2011CORS \u05DE\u05D5\u05D2\u05D3\u05E8 \u05E0\u05DB\u05D5\u05DF":s?.error?.detail?this.result=`\u05E9\u05D2\u05D9\u05D0\u05D4 \u05DE\u05D4\u05E9\u05E8\u05EA: ${s.error.detail}`:this.result="\u05E9\u05D2\u05D9\u05D0\u05D4 \u05D1\u05D4\u05E2\u05DC\u05D0\u05D4",this.uploading=!1,this.progress=0}})}).catch(e=>{console.error(e),this.result="\u05E9\u05D2\u05D9\u05D0\u05D4 \u05D1\u05E2\u05D9\u05D1\u05D5\u05D3 \u05D4\u05EA\u05DE\u05D5\u05E0\u05D4 \u05DC\u05E4\u05E0\u05D9 \u05D4\u05E2\u05DC\u05D0\u05D4",this.uploading=!1,this.progress=0}))}downloadExcel(){let t=localStorage.getItem("session_id");this.http.get(`${x}/download-results?session_id=${t}`,{responseType:"blob"}).subscribe(e=>{let i=window.URL.createObjectURL(e),a=document.createElement("a");a.href=i,a.download="results.xlsx",a.click(),window.URL.revokeObjectURL(i)})}static \u0275fac=function(e){return new(e||r)(I(L))};static \u0275cmp=O({type:r,selectors:[["app-camera"]],decls:14,vars:5,consts:[[1,"camera-container"],[1,"video-wrap"],["id","camera","autoplay","","muted","","playsinline",""],["id","capture","hidden",""],[1,"controls"],[3,"click"],[3,"click","disabled"],["class","upload-status",4,"ngIf"],["class","preview",4,"ngIf"],["class","result",4,"ngIf"],[1,"upload-status"],[1,"progress-bar"],[1,"progress"],[1,"progress-text"],[1,"preview"],["alt","preview","id","preview-img",3,"src"],[1,"result"]],template:function(e,i){e&1&&(c(0,"div",0)(1,"div",1),f(2,"video",2)(3,"canvas",3),o(),c(4,"div",4)(5,"button",5),v("click",function(){return i.capture()}),p(6,"\u{1F4F8} Capture"),o(),c(7,"button",6),v("click",function(){return i.upload()}),p(8),o(),c(9,"button",5),v("click",function(){return i.downloadExcel()}),p(10,"\u2B07\uFE0F Download Excel"),o()(),U(11,j,5,3,"div",7)(12,D,4,1,"div",8)(13,H,5,1,"div",9),o()),e&2&&(l(7),m("disabled",!i.capturedBlob||i.uploading),l(),_(i.uploading?"Uploading...":"Upload"),l(3),m("ngIf",i.uploading),l(),m("ngIf",i.capturedBlob),l(),m("ngIf",i.result))},dependencies:[k,S,B,P],styles:[".camera-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:1rem;align-items:center}.video-wrap[_ngcontent-%COMP%]{width:640px;max-width:100%;background:#000}video#camera[_ngcontent-%COMP%]{width:100%;height:auto;display:block}.controls[_ngcontent-%COMP%]{display:flex;gap:.5rem}.preview[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{max-width:320px;border:1px solid #ccc}.result[_ngcontent-%COMP%]   pre[_ngcontent-%COMP%]{max-width:640px;white-space:pre-wrap;word-break:break-word}.upload-status[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:.5rem}.progress-bar[_ngcontent-%COMP%]{width:300px;height:8px;background:#eee;border-radius:4px;overflow:hidden}.progress[_ngcontent-%COMP%]{height:100%;background:#4caf50;width:0%;transition:width .2s ease}.progress-text[_ngcontent-%COMP%]{font-size:.9rem;color:#333}"]})};export{T as CameraComponent};
