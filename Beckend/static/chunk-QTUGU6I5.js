import{B as b,C as I,D as L,G as S,a as _,f as R,g as a,h as y,i as M,j as O,m as d,n as s,o as r,p as g,q as f,r as v,s as E,t as p,u as w,v as U,y as k,z as P}from"./chunk-2W7OKSWW.js";function T(o,i){if(o&1&&(s(0,"div",10)(1,"div",11),g(2,"div",12),r(),s(3,"div",13),p(4),r()()),o&2){let t=v();a(2),E("width",t.progress,"%"),a(2),U("",t.progress,"% - Uploading...")}}function D(o,i){if(o&1&&(s(0,"div",14)(1,"h3"),p(2,"Preview"),r(),g(3,"img",15),r()),o&2){let t=v();a(3),d("src",t.previewUrl,R)}}function H(o,i){if(o&1&&(s(0,"div",16)(1,"h4"),p(2,"Result"),r(),s(3,"pre"),p(4),r()()),o&2){let t=v();a(4),w(t.result)}}var B=class o{constructor(i){this.http=i}videoRef;canvasRef;stream=null;capturedBlob=null;previewUrl=null;result=null;uploading=!1;progress=0;timeoutMs=3e4;resizeBlob(i,t=1e3,e=.7){return new Promise((n,x)=>{let c=new Image,C=URL.createObjectURL(i);c.onload=()=>{let l=c.width,u=c.height;if(l>t){let m=t/l;l=Math.round(l*m),u=Math.round(u*m)}let h=document.createElement("canvas");h.width=l,h.height=u,h.getContext("2d").drawImage(c,0,0,l,u),h.toBlob(m=>{m?n(m):x(new Error("toBlob failed")),URL.revokeObjectURL(C)},"image/jpeg",e)},c.onerror=l=>{URL.revokeObjectURL(C),x(l)},c.src=C})}ngOnInit(){this.startCamera()}ngOnDestroy(){this.stopCamera(),this.previewUrl&&URL.revokeObjectURL(this.previewUrl)}async startCamera(){try{this.stream=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1}),this.videoRef=document.querySelector("video#camera"),this.videoRef.srcObject=this.stream,await this.videoRef.play()}catch(i){console.error("Camera error",i),this.result="\u05DC\u05D0 \u05D4\u05E6\u05DC\u05D7\u05E0\u05D5 \u05DC\u05D2\u05E9\u05EA \u05DC\u05DE\u05E6\u05DC\u05DE\u05D4"}}stopCamera(){this.stream&&(this.stream.getTracks().forEach(i=>i.stop()),this.stream=null)}capture(){this.canvasRef=document.querySelector("canvas#capture");let i=this.canvasRef.getContext("2d");this.canvasRef.width=this.videoRef.videoWidth||640,this.canvasRef.height=this.videoRef.videoHeight||480,i.drawImage(this.videoRef,0,0,this.canvasRef.width,this.canvasRef.height),this.canvasRef.toBlob(t=>{t&&(this.capturedBlob=t,this.previewUrl&&URL.revokeObjectURL(this.previewUrl),this.previewUrl=URL.createObjectURL(t))},"image/jpeg",.9)}upload(){this.capturedBlob&&(this.uploading=!0,this.progress=0,this.result=null,this.resizeBlob(this.capturedBlob,1e3,.7).then(i=>{let t=new FormData;t.append("file",i,"capture.jpg"),this.progress=5,this.http.post("http://localhost:8000/scan",t,{reportProgress:!0,observe:"events"}).pipe(_(this.timeoutMs)).subscribe({next:e=>{if(e.type===b.UploadProgress){let n=e.total||1;this.progress=Math.round(100*(e.loaded/n))}else if(e.type===b.Response){let n=e.body;n&&n.sr?this.result=`SR: ${n.sr} (rows: ${n.rows})`:this.result=JSON.stringify(n,null,2),this.progress=100,setTimeout(()=>{this.progress=0},300),this.uploading=!1}},error:e=>{console.error(e),e?.name==="TimeoutError"?this.result="\u05D4\u05D1\u05E7\u05E9\u05D4 \u05D4\u05EA\u05E0\u05EA\u05E7\u05D4 \u2014 \u05D7\u05E6\u05D9\u05EA \u05D0\u05EA \u05D6\u05DE\u05DF \u05D4\u05D4\u05DE\u05EA\u05E0\u05D4 (30s). \u05E0\u05E1\u05D9 \u05E9\u05D5\u05D1 \u05D0\u05D5 \u05D1\u05D3\u05E7\u05D9 \u05D7\u05D9\u05D1\u05D5\u05E8 \u05E8\u05E9\u05EA.":e?.status===0?this.result="\u05E9\u05D2\u05D9\u05D0\u05EA \u05E8\u05E9\u05EA \u05D0\u05D5 CORS \u2014 \u05D1\u05D3\u05E7\u05D9 \u05E9\u05D4\u05E9\u05E8\u05EA \u05E8\u05E5 \u05D5\u05E9\u05D4\u2011CORS \u05DE\u05D5\u05D2\u05D3\u05E8 \u05E0\u05DB\u05D5\u05DF":e?.error?.detail?this.result=`\u05E9\u05D2\u05D9\u05D0\u05D4 \u05DE\u05D4\u05E9\u05E8\u05EA: ${e.error.detail}`:this.result="\u05E9\u05D2\u05D9\u05D0\u05D4 \u05D1\u05D4\u05E2\u05DC\u05D0\u05D4",this.uploading=!1,this.progress=0}})}).catch(i=>{console.error(i),this.result="\u05E9\u05D2\u05D9\u05D0\u05D4 \u05D1\u05E2\u05D9\u05D1\u05D5\u05D3 \u05D4\u05EA\u05DE\u05D5\u05E0\u05D4 \u05DC\u05E4\u05E0\u05D9 \u05D4\u05E2\u05DC\u05D0\u05D4",this.uploading=!1,this.progress=0}))}downloadExcel(){window.open("http://localhost:8000/download-results","_blank")}static \u0275fac=function(t){return new(t||o)(y(I))};static \u0275cmp=M({type:o,selectors:[["app-camera"]],decls:14,vars:5,consts:[[1,"camera-container"],[1,"video-wrap"],["id","camera","autoplay","","muted","","playsinline",""],["id","capture","hidden",""],[1,"controls"],[3,"click"],[3,"click","disabled"],["class","upload-status",4,"ngIf"],["class","preview",4,"ngIf"],["class","result",4,"ngIf"],[1,"upload-status"],[1,"progress-bar"],[1,"progress"],[1,"progress-text"],[1,"preview"],["alt","preview","id","preview-img",3,"src"],[1,"result"]],template:function(t,e){t&1&&(s(0,"div",0)(1,"div",1),g(2,"video",2)(3,"canvas",3),r(),s(4,"div",4)(5,"button",5),f("click",function(){return e.capture()}),p(6,"\u{1F4F8} Capture"),r(),s(7,"button",6),f("click",function(){return e.upload()}),p(8),r(),s(9,"button",5),f("click",function(){return e.downloadExcel()}),p(10,"\u2B07\uFE0F Download Excel"),r()(),O(11,T,5,3,"div",7)(12,D,4,1,"div",8)(13,H,5,1,"div",9),r()),t&2&&(a(7),d("disabled",!e.capturedBlob||e.uploading),a(),w(e.uploading?"Uploading...":"Upload"),a(3),d("ngIf",e.uploading),a(),d("ngIf",e.capturedBlob),a(),d("ngIf",e.result))},dependencies:[P,k,S,L],styles:[".camera-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:1rem;align-items:center}.video-wrap[_ngcontent-%COMP%]{width:640px;max-width:100%;background:#000}video#camera[_ngcontent-%COMP%]{width:100%;height:auto;display:block}.controls[_ngcontent-%COMP%]{display:flex;gap:.5rem}.preview[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{max-width:320px;border:1px solid #ccc}.result[_ngcontent-%COMP%]   pre[_ngcontent-%COMP%]{max-width:640px;white-space:pre-wrap;word-break:break-word}.upload-status[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:.5rem}.progress-bar[_ngcontent-%COMP%]{width:300px;height:8px;background:#eee;border-radius:4px;overflow:hidden}.progress[_ngcontent-%COMP%]{height:100%;background:#4caf50;width:0%;transition:width .2s ease}.progress-text[_ngcontent-%COMP%]{font-size:.9rem;color:#333}"]})};export{B as CameraComponent};
